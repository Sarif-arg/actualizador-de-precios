<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Portofino</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 95vh; width: 95vw; margin: 0 auto; }

    /* Estilo panel/leyenda */
    .info-panel.leaflet-control,
    .legend.leaflet-control {
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
      font-family: system-ui, sans-serif;
      color: #333;
    }
    .info-panel.leaflet-control { padding: 10px 14px; max-width: 260px; }
    .info-panel.leaflet-control h4 { margin: 0 0 6px; font-size: 15px; font-weight: 600; }
    .legend.leaflet-control { padding: 8px 12px; font-size: 13px; line-height: 18px; }
    .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: .9; }

    /* Popup lindo */
    .custom-popup .leaflet-popup-content-wrapper {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      padding: 10px; animation: fadeInUp .3s ease-out;
    }
    .custom-popup .leaflet-popup-tip { background: rgba(255,255,255,0.8); backdrop-filter: blur(6px); }
    .popup-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: #333; }
    .popup-info { font-size: .9rem; color: #444; line-height: 1.3; }
    @keyframes fadeInUp { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: none;} }
  </style>
</head>
<body>
  <div id="map"></div>
    <!-- Botones de descarga -->
  <div class="download-buttons">
    <button id="btnComercial">üìÑ Descargar plano comercial</button>
    <button id="btnMensura">üìê Descargar plano con mensura</button>
  </div>

  <style>
    .download-buttons {
      width: 95vw;
      margin: 10px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      flex-wrap: nowrap;
      z-index: 9999;
      position: relative;
    }

    .download-buttons button {
      background: #0066ff;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,.2);
      transition: all 0.25s ease;
    }

    .download-buttons button:hover {
      background: #0050cc;
      transform: translateY(-2px);
    }

    .download-buttons button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,.3);
    }

    @media (max-width: 600px) {
      .download-buttons button {
        font-size: 14px;
        padding: 9px 12px;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    document.getElementById("btnComercial").addEventListener("click", async () => {
      const mapContainer = document.getElementById("map");

      // Ocultamos los popups y elementos interactivos
      const popups = document.querySelectorAll(".leaflet-popup, .leaflet-control-container");
      popups.forEach(el => el.style.display = "none");

      // Tomamos screenshot del mapa
      const canvas = await html2canvas(mapContainer, {
        useCORS: true,
        backgroundColor: "#ffffff",
        scale: 1
      });

      // Restauramos visibilidad
      popups.forEach(el => el.style.display = "");

      // Creamos el PDF en orientaci√≥n vertical
      const imgData = canvas.toDataURL("image/jpeg", 1.0);
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "px",
        format: [canvas.width, canvas.height]
      });

      pdf.addImage(imgData, "JPEG", 0, 0, canvas.width, canvas.height);
      pdf.save("Plano_Terranova_Comercial.pdf");
    });

    document.getElementById("btnMensura").addEventListener("click", () => {
      window.open("https://sarif-arg.github.io/plano_terranova_mensura.pdf", "_blank");
    });
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const originalWidth = 2000, originalHeight = 2828.5715;
    const bounds = [[0,0], [originalHeight, originalWidth]];

    const map = L.map("map", { crs: L.CRS.Simple, minZoom: -2 }).fitBounds(bounds);

    // Fondo SVG (solo imagen, no interactivo)
    L.imageOverlay("plano_terranova_base.svg", bounds, { interactive:false, zIndex:1 }).addTo(map);

    // Colores por estado
    function getColor(estado) {
      switch (estado) {
        case "Disponible": return "#55d400";
        case "Reservado":  return "#ffd93b";
        case "Vendido":    return "#d40000";
        case "Reventa":    return "#0066ff";
        case "No disponible": return "#333";
        default: return "#ccc";
      }
    }

    // Panel de informaci√≥n
    const infoControl = L.control({ position: "topright" });
    infoControl.onAdd = function() {
      this._div = L.DomUtil.create("div", "info-panel leaflet-control");
      this.update();
      return this._div;
    };
    infoControl.update = function(html, title = "Informaci√≥n del lote") {
      this._div.innerHTML = `<h4>${title}</h4>${html || "Seleccione un lote"}`;
    };
    infoControl.addTo(map);

    // Leyenda
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function() {
      const div = L.DomUtil.create("div", "legend leaflet-control");
      div.innerHTML = `
        <div><i style="background:#55d400"></i> Disponible</div>
        <div><i style="background:#ffd93b"></i> Reservado</div>
        <div><i style="background:#d40000"></i> Vendido</div>
        <div><i style="background:#0066ff"></i> Reventa</div>
        <div><i style="background:#333"></i> Pr√≥xima etapa</div>
      `;
      return div;
    };
    legend.addTo(map);

    // Carga de datos
    Promise.all([
      fetch("terranova.geojson").then(r => r.json()),
      fetch("datos_terranova.json").then(r => r.json())
    ])
    .then(([geoData, lotesData]) => {
      function findLoteInfo(geoId) {
        // Normalizar ID: Manzana_X_Lote_Y
        const m = geoId.match(/Manzana_(\w+)_Lote_(\d+[a-zA-Z]?)/i)
        if (!m) return null;
        const sector = "Manzana " + m[1].toUpperCase(); // Sector en JSON est√° con letra may√∫scula
        const numero = m[2];
        const arr = lotesData[sector];
        if (!arr) return null;
        return arr.find(l => l.numero === numero);
      }

      function style(feature) {
        const lote = findLoteInfo(feature.properties.id);
        const estado = lote ? lote.estado : "Desconocido";
        return {
          color: "#333",
          weight: 1,
          fillColor: getColor(estado),
          fillOpacity: 0.6
        };
      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: e => {
            e.target.setStyle({ weight: 3, color: "#000" });
            const id = feature.properties.id.replace(/_/g, " ");
            const lote = findLoteInfo(feature.properties.id);

            if (!lote) {
              infoControl.update(`<div><strong>${id}</strong><br>Sin datos del Terreno</div>`);
            } else if (lote.estado === "No disponible") {
              infoControl.update(
                `<div><strong>No disponible</strong><br>Lote de la pr√≥xima etapa del loteo.</div>`,
                "Pr√≥xima Etapa"
              );
            } else {
              infoControl.update(`
                <div><strong>${id}</strong></div>
                <div>Estado: ${lote.estado}</div>
                <div>Superficie: ${lote.superficie} m¬≤ (${lote.frente}m x ${lote.largo}m) </div>
              `, "Informaci√≥n del lote");
            }
          },
          mouseout: e => {
            geojson.resetStyle(e.target);
            infoControl.update();
          },
          click: e => {
            const id = feature.properties.id.replace(/_/g, " ");
            const lote = findLoteInfo(feature.properties.id);

            if (!lote) {
              infoControl.update(`<div><strong>${id}</strong><br>Sin datos del Terreno</div>`);
              return;
            }
            if (lote.estado === "No Disponible") {
              infoControl.update(
                `<div><strong>No disponible</strong><br>Lote de la pr√≥xima etapa del loteo.</div>`,
                "Pr√≥xima Etapa"
              );
              return;
            }

            // Info del lote
            let html = `
                <div><strong>${id}</strong></div>
                <div>Estado: ${lote.estado}</div>
                <div>Superficie: ${lote.superficie} m¬≤ (${lote.frente}m x ${lote.largo}m) </div>
                <div>Precio de lista: ${lote.precio_contado}</div>
              `;

            if (lote.estado === "Reventa") {
              html += `<div><em>Este lote se vende √∫nicamente de contado.</em></div>`;
            } else {
              const esInmediata = lote.fecha_entrega === "Inmediata";
              const plan1Label = esInmediata ? "36" : "48";
              const plan2Label = esInmediata ? "48" : "72";

              if (lote.plan1_entrega_inicial) {
                html += `
                  <div><strong>Plan ${plan1Label}:</strong> Entrega de ${lote.plan1_entrega_inicial} <br> + ${plan1Label} cuotas de ${lote.plan1_cuotas}</div>
                  <div><strong>Precio final Plan ${plan1Label}:</strong> ${lote.plan1_precio_final}</div>
                `;
              }
              if (lote.plan2_entrega_inicial) {
                html += `
                  <div><strong>Plan ${plan2Label}:</strong> Entrega de ${lote.plan2_entrega_inicial} <br> + ${plan2Label} cuotas de ${lote.plan2_cuotas}</div>
                  <div><strong>Precio final Plan ${plan2Label}:</strong> ${lote.plan2_precio_final}</div>
                `;
              }
            }

            infoControl.update(html, id);
          }
        });
      }

      geojson = L.geoJson(geoData, { style, onEachFeature }).addTo(map);
      geojson.setZIndex(10);
    })
    .catch(err => console.error("‚ùå Error cargando datos:", err));
  </script>
</body>
</html>
